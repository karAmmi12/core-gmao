// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model Asset {
  id           String   @id
  name         String
  serialNumber String   @unique
  status       String
  createdAt    DateTime @default(now())

  // Hiérarchie des actifs (Site > Bâtiment > Ligne > Machine > Composant)
  parentId     String?
  parent       Asset?   @relation("AssetHierarchy", fields: [parentId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  children     Asset[]  @relation("AssetHierarchy")

  // Métadonnées supplémentaires
  assetType    String?  // SITE, BUILDING, LINE, MACHINE, COMPONENT
  location     String?  // Localisation physique
  manufacturer String?  // Fabricant
  modelNumber  String?  // Numéro de modèle

  // Relation : une machine a plusieurs interventions
  workOrders   WorkOrder[]
  maintenanceSchedules MaintenanceSchedule[]

  @@index([parentId])
}

model Technician {
  id          String   @id
  name        String
  email       String   @unique
  phone       String?
  skills      String   // JSON array: ["Électricité", "Mécanique", "Hydraulique"]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  // Relations
  workOrders  WorkOrder[]
  maintenanceSchedules MaintenanceSchedule[]

  @@map("technicians")
}

model WorkOrder {
  id          String   @id
  title       String   // Ex: "Changer le filtre"
  description String?  // Description détaillée
  status      String   // DRAFT, PLANNED, IN_PROGRESS, COMPLETED, CANCELLED
  priority    String   // LOW, HIGH
  type        String   @default("CORRECTIVE") // PREVENTIVE, CORRECTIVE
  createdAt   DateTime @default(now())

  // Planification
  scheduledAt       DateTime?  // Date/heure prévue
  startedAt         DateTime?  // Date/heure de début réel
  completedAt       DateTime?  // Date/heure de fin réelle
  estimatedDuration Int?       // Durée estimée en minutes
  actualDuration    Int?       // Durée réelle en minutes

  // Affectation technicien
  assignedToId String?
  assignedTo   Technician? @relation(fields: [assignedToId], references: [id], onDelete: SetNull)

  // Coûts
  laborCost    Float @default(0)  // Coût main d'œuvre
  materialCost Float @default(0)  // Coût matériel
  totalCost    Float @default(0)  // Coût total

  // Relation vers Asset
  assetId     String
  asset       Asset   @relation(fields: [assetId], references: [id])

  // Pièces utilisées
  parts       WorkOrderPart[]

  @@index([assignedToId])
  @@index([scheduledAt])
  @@index([status])
  @@map("work_orders")
}

model Part {
  id               String   @id
  reference        String   @unique  // Référence unique (ex: FLT-2024-001)
  name             String              // Nom de la pièce
  description      String?             // Description détaillée
  category         String?             // Catégorie (Filtres, Joints, Roulements, etc.)
  unitPrice        Float               // Prix unitaire en €
  quantityInStock  Int      @default(0) // Quantité en stock
  minStockLevel    Int      @default(5) // Seuil d'alerte stock bas
  supplier         String?             // Fournisseur principal
  supplierRef      String?             // Référence fournisseur
  location         String?             // Emplacement dans l'entrepôt
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  stockMovements   StockMovement[]
  workOrderParts   WorkOrderPart[]

  @@index([reference])
  @@index([category])
  @@map("parts")
}

model StockMovement {
  id          String   @id
  partId      String
  part        Part     @relation(fields: [partId], references: [id])
  
  type        String   // IN (entrée) ou OUT (sortie)
  quantity    Int      // Quantité (positif pour entrée, négatif pour sortie)
  reason      String?  // Raison: "Achat", "Utilisation intervention", "Correction inventaire", etc.
  reference   String?  // Référence externe (bon de commande, n° intervention, etc.)
  
  createdAt   DateTime @default(now())
  createdBy   String?  // ID utilisateur (pour traçabilité future)

  @@index([partId])
  @@index([type])
  @@index([createdAt])
  @@map("stock_movements")
}

model WorkOrderPart {
  id           String     @id
  workOrderId  String
  workOrder    WorkOrder  @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  
  partId       String
  part         Part       @relation(fields: [partId], references: [id])
  
  quantity     Int        // Quantité utilisée
  unitPrice    Float      // Prix unitaire au moment de l'utilisation (historique)
  totalPrice   Float      // Prix total = quantity * unitPrice
  
  createdAt    DateTime   @default(now())

  @@index([workOrderId])
  @@index([partId])
  @@map("work_order_parts")
}

model MaintenanceSchedule {
  id                String    @id
  assetId           String
  asset             Asset     @relation(fields: [assetId], references: [id], onDelete: Cascade)
  
  title             String    
  description       String?   
  
  frequency         String    // DAILY, WEEKLY, MONTHLY, QUARTERLY, YEARLY
  intervalValue     Int       @default(1)
  
  lastExecutedAt    DateTime? 
  nextDueDate       DateTime 
  
  estimatedDuration Float?    
  assignedToId      String?   
  assignedTo        Technician? @relation(fields: [assignedToId], references: [id])
  
  isActive          Boolean   @default(true)
  priority          String    @default("LOW")
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([assetId])
  @@index([nextDueDate])
  @@index([isActive])
  @@map("maintenance_schedules")
}

// Configuration dynamique pour rendre l'application adaptable à tout type d'entreprise
model ConfigurationCategory {
  id          String   @id
  code        String   @unique  // TECHNICIAN_SKILL, ASSET_TYPE, WORK_ORDER_TYPE, PRIORITY, etc.
  name        String              // Nom affiché
  description String?             // Description de la catégorie
  isSystem    Boolean  @default(false) // True si ne peut pas être supprimée
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)     // Ordre d'affichage
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items       ConfigurationItem[]

  @@map("configuration_categories")
}

model ConfigurationItem {
  id          String   @id
  categoryId  String
  category    ConfigurationCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  code        String              // Code technique (ex: ELECTRICAL, MECHANICAL)
  label       String              // Libellé affiché (ex: "Électricité", "Mécanique")
  description String?             // Description détaillée
  color       String?             // Couleur pour l'UI (ex: "#3b82f6")
  icon        String?             // Nom d'icône (ex: "wrench", "bolt")
  
  isDefault   Boolean  @default(false) // Item par défaut dans sa catégorie
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)     // Ordre d'affichage
  
  // Métadonnées additionnelles (JSON flexible)
  metadata    String?             // JSON pour données spécifiques
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([categoryId, code])
  @@index([categoryId])
  @@index([isActive])
  @@map("configuration_items")
}
